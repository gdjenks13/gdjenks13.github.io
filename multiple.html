<!DOCTYPE html>
<html>
  <head>
    <title>Route to Multiple Places</title>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQBeSW8Aaji0natOah-pS7a6mNZlg-9KY&libraries=places&callback=initMap"
      defer
    ></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      h1 {
        margin-bottom: 0;
      }
      ul {
        list-style-type: none;
        padding-left: 0;
      }
      li {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .destination-input {
        margin-bottom: 5px;
      }
      .remove-btn {
        margin-left: 10px;
        color: red;
        cursor: pointer;
      }
      .results-grid {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .results-col {
        flex: 1 1 0;
        min-width: 220px;
        border-radius: 8px;
        padding: 10px;
        /* background is set inline for each type */
      }
      .results-col h2 {
        text-align: center;
        font-size: 1.1em;
        margin-top: 0;
        margin-bottom: 10px;
        letter-spacing: 1px;
      }
      .results-list li {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .results-row {
        display: flex;
        gap: 20px;
        align-items: flex-start;
      }
      .results-row > div {
        flex: 1;
      }
      @media (max-width: 900px) {
        .results-grid {
          flex-direction: column;
        }
        .results-col {
          min-width: unset;
          margin-bottom: 20px;
        }
      }
    </style>
  </head>
  <body>
    <h1>Distances to Olentangy Schools</h1>
    <form id="addressForm" onsubmit="return false;">
      <label>
        <strong>From:</strong>
        <input type="text" id="origin" value="6517 S Section Line Rd, Delaware, OH 43015" size="40" />
      </label>
      <br/><br/>
      <strong>Destinations:</strong>
      <button type="button" id="toggleDestinationsBtn" style="margin-left:10px;">Hide Destinations</button>
      <div id="destinationsContainer">
        <div id="destinationsList"></div>
        <button type="button" onclick="addDestination()">Add Destination</button>
      </div>
      <br/><br/>
      <button type="button" onclick="calculateDistances()">Calculate Distances</button>
    </form>
    <div id="results">Loading...</div>

    <script>
      // Initial destinations with type and title
      let destinations = [
        { title: "Olentangy Berkshire MS", address: "2869 S Three B's & K Rd, Galena, OH 43021", type: "Middle" },
        { title: "Olentangy Hyatts MS", address: "6885 Sawmill Pkwy, Powell, OH 43065", type: "Middle" },
        { title: "Olentangy Liberty MS", address: "7940 Liberty Rd N, Powell, OH 43065", type: "Middle" },
        { title: "Olentangy Orange MS", address: "2680 E Orange Rd, Lewis Center, OH 43035", type: "Middle" },
        { title: "Olentangy Shanahan MS", address: "814 Shanahan Rd, Lewis Center, OH 43035", type: "Middle" },
        { title: "Olentangy Berlin MS", address: "2500 Piatt Rd, Delaware, OH 43015", type: "Middle" },
        { title: "Alum Creek ES", address: "2515 Parklawn Dr, Lewis Center, OH 43035", type: "Elementary" },
        { title: "Arrowhead ES", address: "2385 Hollenback Rd, Lewis Center, OH 43035", type: "Elementary" },
        { title: "Cheshire ES", address: "2681 Gregory Rd, Delaware, OH 43015", type: "Elementary" },
        { title: "Freedom Trail ES", address: "6743 Bale Kenyon Rd, Lewis Center, OH 43035", type: "Elementary" },
        { title: "Glen Oak ES", address: "7300 Blue Holly Dr, Lewis Center, OH 43035", type: "Elementary" },
        { title: "Heritage ES", address: "679 Lewis Center Rd, Lewis Center, OH 43035", type: "Elementary" },
        { title: "Indian Springs ES", address: "3828 Home Rd, Powell, OH 43065", type: "Elementary" },
        { title: "Johnnycake Corners ES", address: "6783 Falling Meadows Dr, Galena, OH 43021", type: "Elementary" },
        { title: "Liberty Tree ES", address: "6877 Sawmill Pkwy, Powell, OH 43065", type: "Elementary" },
        { title: "Oak Creek ES", address: "1256 Westwood Dr, Lewis Center, OH 43035", type: "Elementary" },
        { title: "Olentangy Meadows ES", address: "8950 Emerald Hill Dr, Lewis Center, OH 43035", type: "Elementary" },
        { title: "Peachblow Crossing ES", address: "4222 Peachblow Rd, Delaware, OH 43015", type: "Elementary" },
        { title: "Scioto Ridge ES", address: "8715 Big Bear Ave, Powell, OH 43065", type: "Elementary" },
        { title: "Shale Meadows ES", address: "4458 North Rd, Lewis Center, OH 43035", type: "Elementary" },
        { title: "Tyler Run ES", address: "580 Salisbury Dr, Powell, OH 43065", type: "Elementary" },
        { title: "Walnut Creek ES", address: "5600 Grand Oak Blvd, Galena, OH 43021", type: "Elementary" },
        { title: "Wyandot Run ES", address: "2800 Carriage Rd, Powell, OH 43065", type: "Elementary" },
        { title: "Croop House", address: "4268 Laurel Valley Rd, Powell, OH 43065", type: "Family" },
        { title: "Marquis House", address: "644 Fenwick Pl, Powell, OH 43065", type: "Family" },
        { title: "Jenkins House", address: "2102 Waycross Ave, Akron, OH 44320", type: "Family" },
        { title: "Grant House", address: "3640 Hickory Rock Dr, Powell, OH 43065", type: "Family"},
        { title: "Contrast Church", address: "960 King Ave, Columbus, OH 43212", type: "Church" },
      ];

      function getLabelColor(type) {
        if (type === 'Middle') return '#cce6ff';        // light blue
        if (type === 'Elementary') return '#d4f7d4';    // light green
        if (type === 'Family') return '#ffe6b3';        // light orange
        if (type === 'Church') return '#f7d4f7';        // light purple/pink
        return '#eee';                                  // default gray
      }

      function renderDestinations() {
        const list = document.getElementById('destinationsList');
        list.innerHTML = '';
        destinations.forEach((dest, i) => {
          const div = document.createElement('div');
          div.className = 'destination-input';
          div.innerHTML = `
            <input type="text" placeholder="School Name" value="${dest.title || ''}" size="18" onchange="updateDestinationTitle(${i}, this.value)" />
            <input type="text" placeholder="Address" value="${dest.address}" size="40" onchange="updateDestinationAddress(${i}, this.value)" />
            <span class="label-toggle">
              <button type="button" onclick="toggleType(${i})" style="background:${getLabelColor(dest.type)};border:none;padding:4px 10px;border-radius:5px;cursor:pointer;">
                ${dest.type}
              </button>
            </span>
            <span class="remove-btn" onclick="removeDestination(${i})">&#10060;</span>
          `;
          list.appendChild(div);
        });
      }

      function addDestination() {
        destinations.push({ title: '', address: '', type: 'Middle' });
        renderDestinations();
      }

      function removeDestination(index) {
        destinations.splice(index, 1);
        renderDestinations();
      }

      function updateDestinationAddress(index, value) {
        destinations[index].address = value;
      }

      function updateDestinationTitle(index, value) {
        destinations[index].title = value;
      }

      function toggleType(index) {
        // Cycle through all types
        const types = ['Middle', 'Elementary', 'Family', 'Church'];
        const current = types.indexOf(destinations[index].type);
        destinations[index].type = types[(current + 1) % types.length];
        renderDestinations();
      }

      // Cache for last calculated origin and destination addresses/results
      let lastOrigin = '';
      let lastDestCache = {}; // { address: { result, title, type } }

      function calculateDistances() {
        const origin = document.getElementById('origin').value.trim();
        const filteredDestinations = destinations
          .map(d => ({ ...d }))
          .filter(d => d.address.trim() !== '');

        if (!origin || filteredDestinations.length === 0) {
          document.getElementById('results').innerText = 'Please enter an origin and at least one destination.';
          return;
        }
        document.getElementById('results').innerText = 'Loading...';

        // If origin changed, clear cache
        if (origin !== lastOrigin) {
          lastDestCache = {};
          lastOrigin = origin;
        }

        // Find which destinations need to be (re)calculated
        let toFetch = [];
        let cachedResults = [];
        filteredDestinations.forEach(dest => {
          const cache = lastDestCache[dest.address];
          if (!cache || cache.title !== dest.title || cache.type !== dest.type) {
            toFetch.push(dest);
          } else {
            cachedResults.push(cache);
          }
        });

        if (toFetch.length === 0) {
          // All results are cached, just display
          displayResults(cachedResults);
          return;
        }

        // Batch API calls if needed
        const MAX_DEST = 25;
        let batches = [];
        for (let i = 0; i < toFetch.length; i += MAX_DEST) {
          batches.push(toFetch.slice(i, i + MAX_DEST));
        }

        let newResults = [];
        let completed = 0;

        batches.forEach(batch => {
          const service = new google.maps.DistanceMatrixService();
          service.getDistanceMatrix(
            {
              origins: [origin],
              destinations: batch.map(d => d.address),
              travelMode: google.maps.TravelMode.DRIVING,
              unitSystem: google.maps.UnitSystem.IMPERIAL,
            },
            (response, status) => {
              completed++;
              if (status === "OK") {
                const results = response.rows[0].elements;
                batch.forEach((dest, i) => {
                  const resultObj = {
                    title: dest.title,
                    address: dest.address,
                    type: dest.type,
                    result: results[i]
                  };
                  lastDestCache[dest.address] = resultObj;
                  newResults.push(resultObj);
                });
              } else {
                batch.forEach(dest => {
                  const resultObj = {
                    title: dest.title,
                    address: dest.address,
                    type: dest.type,
                    result: { status }
                  };
                  lastDestCache[dest.address] = resultObj;
                  newResults.push(resultObj);
                });
              }
              if (completed === batches.length) {
                // Merge cached and new results for current destinations
                const allResults = filteredDestinations.map(dest => lastDestCache[dest.address]);
                displayResults(allResults);
              }
            }
          );
        });

        // If all were cached, display immediately
        if (batches.length === 0) {
          displayResults(filteredDestinations.map(dest => lastDestCache[dest.address]));
        }
      }

      function getPanelColor(type) {
        if (type === 'Middle') return '#cce6ff';        // light blue
        if (type === 'Elementary') return '#d4f7d4';    // light green
        if (type === 'Family') return '#ffe6b3';        // light orange
        if (type === 'Church' || type === 'Other') return '#f7d4f7'; // light purple/pink
        return '#eee';                                  // default gray
      }

      function displayResults(allResults) {
        // Sort by drive time ascending (if available)
        allResults.sort((a, b) => {
          if (a.result.status !== "OK") return 1;
          if (b.result.status !== "OK") return -1;
          return a.result.duration.value - b.result.duration.value;
        });

        // Group results by type
        const columns = {
          'Elementary': [],
          'Middle': [],
          'Family': [],
          'Other': []
        };

        allResults.forEach(item => {
          let group = item.type;
          if (group !== 'Elementary' && group !== 'Middle' && group !== 'Family') {
            group = 'Other';
          }
          if (item.result.status === "OK") {
            columns[group].push(`
              <li>
                <div class="results-row">
                  <div>
                    <strong>${item.title ? item.title : ""}</strong>
                  </div>
                  <div>
                    <strong>Drive Time:</strong> ${item.result.duration.text}
                  </div>
                </div>
                <div class="results-row">
                  <div>
                    <span style="font-size:0.95em;">${item.address}</span>
                  </div>
                  <div>
                    <strong>Distance:</strong> ${item.result.distance.text}
                  </div>
                </div>
              </li>
            `);
          } else {
            columns[group].push(`
              <li>
                <div class="results-row">
                  <div>
                    <strong>${item.title ? item.title : ""}</strong>
                  </div>
                  <div>
                    <span style="color:red;">${item.result.status}</span>
                  </div>
                </div>
                <div class="results-row">
                  <div>
                    <span style="font-size:0.95em;">${item.address}</span>
                  </div>
                  <div></div>
                </div>
              </li>
            `);
          }
        });

        // Column titles and panel colors
        const colTitles = {
          'Elementary': 'Elementary',
          'Middle': 'Middle',
          'Family': 'Family',
          'Other': 'Other'
        };
        const colColors = {
          'Elementary': getPanelColor('Elementary'),
          'Middle': getPanelColor('Middle'),
          'Family': getPanelColor('Family'),
          'Other': getPanelColor('Other')
        };

        // Build the grid
        let html = `<div class="results-grid">`;
        for (const key of ['Elementary', 'Middle', 'Family', 'Other']) {
          html += `
            <div class="results-col" style="background:${colColors[key]}">
              <h2>${colTitles[key]}</h2>
              <ul class="results-list">${columns[key].join('')}</ul>
            </div>
          `;
        }
        html += `</div>`;
        document.getElementById("results").innerHTML = html;
      }

      // Collapsible destinations logic
      let destinationsVisible = true;
      const destinationsContainer = document.getElementById('destinationsContainer');
      const toggleBtn = document.getElementById('toggleDestinationsBtn');
      toggleBtn.addEventListener('click', function() {
        destinationsVisible = !destinationsVisible;
        destinationsContainer.style.display = destinationsVisible ? '' : 'none';
        toggleBtn.textContent = destinationsVisible ? 'Hide Destinations' : 'Show Destinations';
      });

      function initMap() {
        renderDestinations();
        calculateDistances();
      }

      window.initMap = initMap;
    </script>
  </body>
</html>
